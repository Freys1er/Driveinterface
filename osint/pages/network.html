<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Network Graph - ContactOSINT</title>
    <link rel="stylesheet" href="../style.css">
    <style>
        /* Styles specific to the network page */
        #page-content {
            padding: 0; /* Remove padding for full-screen canvas */
            height: calc(100vh - 61px); /* Full height minus header */
            position: relative;
        }
        #network-container { position: relative; width: 100%; height: 100%; overflow: hidden; }
        #network-canvas { display: block; width: 100%; height: 100%; cursor: grab; background-color: #000; }
        #network-canvas.grabbing { cursor: grabbing; }
        #ui-controls { 
            position: absolute; 
            bottom: 10px; 
            right: 10px; 
            background-color: rgba(0,0,0,0.7); 
            padding: 10px; 
            border-radius: 5px; 
            border: 1px solid #0f0; 
            color: #0f0; 
            display: none; /* Hidden by default, shown by script */
            gap: 10px; 
            align-items: center; 
            z-index: 1000; 
        }
        #ui-controls button, #ui-controls input { background-color: #222; color: #0f0; border: 1px solid #0f0; padding: 5px 10px; font-family: "Courier New", Courier, monospace; cursor: pointer; }
        #ui-controls input { width: 80px; }
        #ui-controls button:hover { background-color: #0f0; color: #000; }
    </style>
</head>
<body>

    <div id="app-container">
        <header>
            <nav>
                <a href="./dashboard.html">Dashboard</a>
                <a href="./list.html">Contacts</a>
                <a href="./network.html">Network</a>
            </nav>
            <button id="signout-button" class="btn">Sign Out</button>
        </header>

        <main id="page-content">
             <div id="network-container">
                <canvas id="network-canvas"></canvas>
                <div id="ui-controls">
                    <button id="add-button">Add</button>
                    <button id="pause-button">Pause</button>
                    <input type="text" id="find-input" placeholder="Initials..">
                    <button id="find-button">Find</button>
                </div>
            </div>
        </main>
    </div>

    <!-- Load all necessary scripts -->
    <script src="../js/drive.js"></script>
    <script src="../js/app.js"></script>
    <script src="../js/network.js"></script>

    <!-- ===== ROBUST SCRIPT BLOCK ===== -->
    <script>
        document.getElementById('signout-button').addEventListener('click', () => {
            localStorage.removeItem(App.TOKEN_STORAGE_KEY);
            window.location.href = '/';
        });
        
        /**
         * Page-specific logic: Get contacts and initialize the graph.
         */
        function runPageLogic() {
            const contacts = App.getContacts();
            const container = document.getElementById('network-container');
            // Call the function from network.js with the REAL contacts
            initializeNetworkGraph(container, contacts);
        }

        async function initializeAndRun() {
            try {
                await gapi.client.init({
                    discoveryDocs: ['https://www.googleapis.com/discovery/v1/apis/drive/v3/rest'],
                });
                const isAuthenticated = await App.initializeAndAuth();
                if (isAuthenticated) {
                    await App.loadContacts(); // IMPORTANT: Load contacts first!
                    runPageLogic();
                }
            } catch (error) {
                console.error("Initialization Error:", error);
                document.getElementById('page-content').innerHTML = `<h1>Error</h1><p>Could not initialize the application.</p>`;
            }
        }
        
        function loadScript(src) {
            return new Promise((resolve, reject) => {
                const script = document.createElement('script');
                script.src = src;
                script.async = true;
                script.defer = true;
                script.onload = resolve;
                script.onerror = reject;
                document.head.appendChild(script);
            });
        }

        loadScript('https://apis.google.com/js/api.js')
            .then(() => gapi.load('client', initializeAndRun))
            .catch(error => console.error('Failed to load Google API script:', error));
    </script>
</body>
</html>