<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - ContactOSINT</title>
    <link rel="stylesheet" href="../style.css">
</head>
<body>

    <div id="app-container">
        <header>
            <nav>
                <a href="./dashboard.html">Dashboard</a>
                <a href="./list.html">Contacts</a>
                <a href="./network.html">Network</a>
            </nav>
            <button id="signout-button" class="btn">Sign Out</button>
        </header>

        <main id="page-content">
            <div class="dashboard-grid">
                <div class="widget">
                    <h2>Welcome to ContactOSINT</h2>
                    <p>This tool is an extension of your Drive Notes app.</p>
                </div>
                <div class="widget">
                    <h2>Quick Stats</h2>
                    <p>Total Contacts: <span id="contact-count">Loading...</span></p>
                </div>
            </div>
        </main>
    </div>

    <!-- External library scripts first -->
    <script src="../js/drive.js"></script>
    <script src="../js/app.js"></script>

    <!-- ===== START: NEW ROBUST SCRIPT BLOCK ===== -->
    <script>
        // --- EVENT LISTENERS ---
        document.getElementById('signout-button').addEventListener('click', () => {
            localStorage.removeItem(App.TOKEN_STORAGE_KEY);
            window.location.href = '/'; // Redirect to the main app's login
        });
        
        /**
         * This function contains the logic specific to THIS page (dashboard.html).
         */
        async function runPageLogic() {
            await App.loadContacts();
            const contacts = App.getContacts();
            document.getElementById('contact-count').textContent = contacts.length;
        }

        /**
         * This is the main bootstrap function that runs after GAPI is ready.
         */
        async function initializeAndRun() {
            try {
                await gapi.client.init({
                    discoveryDocs: ['https://www.googleapis.com/discovery/v1/apis/drive/v3/rest'],
                });
                const isAuthenticated = await App.initializeAndAuth();
                if (isAuthenticated) {
                    runPageLogic();
                }
            } catch (error) {
                console.error("Initialization or Authentication Error:", error);
                document.getElementById('page-content').innerHTML = `<h1>Error</h1><p>Could not initialize the application.</p><a href="/">Return to Login</a>`;
            }
        }
        
        /**
         * Dynamically loads a script and returns a promise.
         */
        function loadScript(src) {
            return new Promise((resolve, reject) => {
                const script = document.createElement('script');
                script.src = src;
                script.async = true;
                script.defer = true;
                script.onload = resolve;
                script.onerror = reject;
                document.head.appendChild(script);
            });
        }

        // --- APPLICATION ENTRY POINT ---
        loadScript('https://apis.google.com/js/api.js')
            .then(() => {
                gapi.load('client', initializeAndRun);
            })
            .catch(error => {
                console.error('Failed to load Google API script:', error);
                document.body.innerHTML = '<h1>Critical Error</h1><p>Could not load Google libraries.</p>';
            });
    </script>
    <!-- ===== END: NEW ROBUST SCRIPT BLOCK ===== -->

</body>
</html>