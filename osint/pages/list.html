<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>All Contacts - ContactOSINT</title>
    <link rel="stylesheet" href="../style.css">
</head>
<body>

    <div id="app-container">
        <header>
            <nav>
                <a href="./dashboard.html">Dashboard</a>
                <a href="./list.html">Contacts</a>
                <a href="./network.html">Network</a>
            </nav>
            <button id="signout-button" class="btn">Sign Out</button>
        </header>

        <main id="page-content">
            <div class="contact-list-header">
                <h2>All Contacts</h2>
                <a href="./contact.html?new=true" class="btn">Add New Contact</a>
            </div>
            <div id="contacts-container">
                <p>Loading...</p>
            </div>
        </main>
    </div>
    
    <!-- External library scripts first -->
    <script src="../js/drive.js"></script>
    <script src="../js/app.js"></script>

    <!-- ===== START: NEW ROBUST SCRIPT BLOCK ===== -->
    <script>
        // --- EVENT LISTENERS ---
        document.getElementById('signout-button').addEventListener('click', () => {
            localStorage.removeItem(App.TOKEN_STORAGE_KEY);
            window.location.href = '/'; // Redirect to the main app's login
        });

        /**
         * This function contains the logic specific to THIS page (list.html).
         * It will only run AFTER authentication is confirmed.
         */
        async function runPageLogic() {
            await App.loadContacts();
            const contacts = App.getContacts();
            const container = document.getElementById('contacts-container');
            
            if (!contacts || contacts.length === 0) {
                container.innerHTML = '<p>No contacts found. Click "Add New Contact" to get started.</p>';
                return;
            }

            const sortedContacts = contacts.sort((a, b) => {
                const nameA = (a.firstName || '').toLowerCase();
                const nameB = (b.firstName || '').toLowerCase();
                if (nameA < nameB) return -1;
                if (nameA > nameB) return 1;
                return 0;
            });

            container.innerHTML = ''; // Clear loading message
            sortedContacts.forEach(contact => {
                const contactEl = document.createElement('a');
                contactEl.href = `./contact.html?id=${contact.id}`;
                contactEl.className = 'contact-item';
                
                const displayName = (contact.firstName || contact.lastName) 
                    ? `${contact.firstName || ''} ${contact.lastName || ''}`.trim() 
                    : '[Unnamed Contact]';
                    
                contactEl.textContent = displayName;
                container.appendChild(contactEl);
            });
        }

        /**
         * This is the main bootstrap function that runs after GAPI is ready.
         * It initializes the Google API client and then runs the authentication check.
         */
        async function initializeAndRun() {
            try {
                // Initialize the GAPI client for the Drive API
                await gapi.client.init({
                    discoveryDocs: ['https://www.googleapis.com/discovery/v1/apis/drive/v3/rest'],
                });

                // Check if the user is properly authenticated
                const isAuthenticated = await App.initializeAndAuth();
                
                // Only run the page's main function if authentication succeeds.
                if (isAuthenticated) {
                    runPageLogic();
                }
            } catch (error) {
                console.error("Initialization or Authentication Error:", error);
                document.getElementById('page-content').innerHTML = `<h1>Error</h1><p>Could not initialize the application. Your session may be invalid.</p><a href="/">Return to Login</a>`;
            }
        }
        
        /**
         * Dynamically loads a script and returns a promise.
         * This avoids the race condition of using onload="...".
         */
        function loadScript(src) {
            return new Promise((resolve, reject) => {
                const script = document.createElement('script');
                script.src = src;
                script.async = true;
                script.defer = true;
                script.onload = resolve;
                script.onerror = reject;
                document.head.appendChild(script);
            });
        }

        // --- APPLICATION ENTRY POINT ---
        // This is what starts the entire process.
        loadScript('https://apis.google.com/js/api.js')
            .then(() => {
                // Once the main GAPI script is loaded, load the 'client' module.
                // The callback `initializeAndRun` will be executed once the client is ready.
                gapi.load('client', initializeAndRun);
            })
            .catch(error => {
                console.error('Failed to load Google API script:', error);
                document.body.innerHTML = '<h1>Critical Error</h1><p>Could not load Google libraries. Please check your internet connection and ad-blockers.</p>';
            });

    </script>
    <!-- ===== END: NEW ROBUST SCRIPT BLOCK ===== -->

</body>
</html>