<!-- osint/pages/contact.html -->
<div id="contact-container">
    <!-- Content will be rendered here by the script -->
</div>

<style>
    .contact-form .form-group {
        margin-bottom: 1.5rem;
    }
    .contact-form label {
        display: block;
        margin-bottom: 0.5rem;
        font-weight: bold;
    }
    .contact-form input,
    .contact-form textarea,
    .contact-form select {
        width: 100%;
        padding: 0.75rem;
        box-sizing: border-box;
        background-color: #3c3c3c;
        border: 1px solid var(--border-color);
        border-radius: 5px;
        color: var(--text-color);
        font-size: 1rem;
    }
    .contact-view-data {
        background-color: var(--surface-color);
        padding: 1rem;
        border-radius: 5px;
        white-space: pre-wrap;
    }
    .btn-bar {
        margin-top: 1.5rem;
        display: flex;
        gap: 1rem;
    }
    .relations-section {
        margin-top: 2rem;
        padding-top: 1.5rem;
        border-top: 1px solid var(--border-color);
    }
    .relation-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 0.75rem;
        background-color: var(--surface-color);
        border-radius: 5px;
        margin-bottom: 0.5rem;
    }
    .add-relation-form {
        display: flex;
        gap: 1rem;
        margin-top: 1rem;
    }
    .remove-relation-btn {
        background-color: #c0392b;
        color: white;
        border: none;
        padding: 5px 10px;
        border-radius: 5px;
        cursor: pointer;
    }
</style>

<script>
    (function() {
        const container = document.getElementById('contact-container');
        const hash = window.location.hash;
        const queryString = hash.split('?')[1] || '';
        const urlParams = new URLSearchParams(queryString);

        const contactId = urlParams.get('id');
        const isNew = urlParams.has('new');
        const isEdit = urlParams.has('edit');

        const allContacts = App.getContacts();
        let contactData = null;

        if (contactId) {
            contactData = allContacts.find(c => c.id === contactId);
        }

        // --- RENDER LOGIC ---
        if (isNew) {
            renderForm({}); // New contact form
        } else if (isEdit && contactData) {
            renderForm(contactData); // Edit existing contact form
        } else if (contactData) {
            renderView(contactData); // View contact details
        } else {
            container.innerHTML = `<h2>Contact Not Found</h2><a href="#list" class="btn">Back to List</a>`;
        }
        
        // --- VIEW / FORM RENDERING ---
        function renderView(contact) {
            let relationsHtml = '<p>No relationships defined.</p>';
            if (contact.relations && contact.relations.length > 0) {
                relationsHtml = contact.relations.map(rel => {
                    const target = allContacts.find(c => c.id === rel.contactId);
                    return `<div class="relation-item"><span>→ ${target ? target.firstName : 'Unknown'} (${rel.type})</span></div>`;
                }).join('');
            }

            container.innerHTML = `
                <h2>${contact.firstName || ''} ${contact.lastName || ''}</h2>
                <h4>Notes</h4>
                <div class="contact-view-data">${contact.notes || 'N/A'}</div>
                <div class="relations-section">
                    <h3>Relationships</h3>
                    ${relationsHtml}
                </div>
                <div class="btn-bar">
                    <a href="#contact?edit=true&id=${contact.id}" class="btn">Edit</a>
                    <a href="#list" class="btn" style="background-color:#555;">Back to List</a>
                </div>
            `;
        }

        function renderForm(contact) {
            // State for the form's relations
            let currentRelations = contact.relations ? [...contact.relations] : [];
            const otherContacts = allContacts.filter(c => c.id !== contact.id);

            const selectOptions = otherContacts.map(c => `<option value="${c.id}">${c.firstName} ${c.lastName}</option>`).join('');

            container.innerHTML = `
                <h2>${contact.id ? 'Edit Contact' : 'Add New Contact'}</h2>
                <form id="contactForm" class="contact-form">
                    <!-- Standard Fields -->
                    <div class="form-group"><label for="firstName">First Name</label><input type="text" id="firstName" value="${contact.firstName || ''}"></div>
                    <div class="form-group"><label for="lastName">Last Name</label><input type="text" id="lastName" value="${contact.lastName || ''}"></div>
                    <div class="form-group"><label for="notes">Notes</label><textarea id="notes" rows="6">${contact.notes || ''}</textarea></div>
                    
                    <!-- Relations Section -->
                    <div class="relations-section">
                        <h3>Relationships</h3>
                        <div id="relations-list"></div>
                        <h4>Add New Relationship</h4>
                        <div class="add-relation-form">
                            <select id="relation-contact-select" ${otherContacts.length === 0 ? 'disabled' : ''}>
                                ${otherContacts.length > 0 ? selectOptions : '<option>No other contacts exist</option>'}
                            </select>
                            <input type="text" id="relation-type" placeholder="e.g., Friend, Colleague">
                            <button type="button" id="add-relation-btn" class="btn">Add</button>
                        </div>
                    </div>

                    <!-- Action Buttons -->
                    <div class="btn-bar"><button type="submit" class="btn">Save</button><a href="#list" class="btn" style="background-color:#555;">Cancel</a></div>
                </form>
            `;

            const relationsListEl = document.getElementById('relations-list');

            function displayRelations() {
                if (currentRelations.length === 0) {
                    relationsListEl.innerHTML = '<p>No relationships defined.</p>';
                    return;
                }
                relationsListEl.innerHTML = currentRelations.map(rel => {
                    const target = allContacts.find(c => c.id === rel.contactId);
                    return `
                        <div class="relation-item">
                            <span>→ ${target ? target.firstName : 'Unknown'} (${rel.type})</span>
                            <button type="button" class="remove-relation-btn" data-id="${rel.contactId}">Remove</button>
                        </div>`;
                }).join('');
            }

            // Event Listeners for the form
            document.getElementById('add-relation-btn').addEventListener('click', () => {
                const selectEl = document.getElementById('relation-contact-select');
                const typeEl = document.getElementById('relation-type');
                if (!selectEl.value || !typeEl.value) {
                    alert('Please select a contact and enter a relationship type.');
                    return;
                }
                currentRelations.push({ contactId: selectEl.value, type: typeEl.value });
                typeEl.value = '';
                displayRelations();
            });

            relationsListEl.addEventListener('click', (e) => {
                if (e.target.classList.contains('remove-relation-btn')) {
                    const targetId = e.target.getAttribute('data-id');
                    currentRelations = currentRelations.filter(r => r.contactId !== targetId);
                    displayRelations();
                }
            });
            
            document.getElementById('contactForm').addEventListener('submit', (e) => {
                e.preventDefault();
                const savedData = {
                    id: contact.id || 'C' + Date.now(),
                    firstName: document.getElementById('firstName').value,
                    lastName: document.getElementById('lastName').value,
                    notes: document.getElementById('notes').value,
                    relations: currentRelations
                };

                let updatedList;
                if (contact.id) { // Editing existing
                    updatedList = allContacts.map(c => c.id === contact.id ? savedData : c);
                } else { // Creating new
                    updatedList = [...allContacts, savedData];
                }
                App.saveContacts(updatedList);
            });

            displayRelations(); // Initial render of relations
        }
    })();
</script>