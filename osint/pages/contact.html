<style>
    /* ... your existing styles ... */
    .contact-container { padding: 1.5rem; max-width: 800px; margin: 0 auto; }
    .form-group { margin-bottom: 1.5rem; }
    .form-group label { display: block; margin-bottom: 0.5rem; opacity: 0.8; }
    .form-group input, .form-group textarea {
        width: 100%; box-sizing: border-box; background: #111;
        border: 1px solid rgba(0, 255, 0, 0.3); color: #00ff00;
        padding: 0.75rem; font-family: inherit; font-size: 1rem;
    }
    .btn-bar { margin-top: 2rem; display: flex; gap: 1rem; }
    .btn {
        background: transparent; border: 1px solid #00ff00; color: #00ff00;
        padding: 0.75rem 1.5rem; font-family: inherit; cursor: pointer;
        text-decoration: none; display: inline-block;
    }
</style>

<div id="contact-root" class="contact-container">
    <h1>Initializing Contact Page...</h1>
</div>

<!-- This indicator is for visual debugging -->
<div id="script-status-indicator" style="position: fixed; bottom: 10px; left: 10px; background: red; color: white; padding: 5px; font-family: monospace;">
    SCRIPT NOT STARTED
</div>

<script>
    // THE DEFINITIVE FIX: Wait for the HTML to be ready before running any code.
    document.addEventListener('DOMContentLoaded', function() {
    
        // The very first action is to provide visual feedback that the script is running.
        document.getElementById('script-status-indicator').textContent = 'SCRIPT RUNNING';
        document.getElementById('script-status-indicator').style.background = 'green';
        
        const rootEl = document.getElementById('contact-root');
        console.log('[Contact] DOMContentLoaded event fired. Script is now safely executing.');

        try {
            const allContacts = App.getContacts();
            if (!Array.isArray(allContacts)) {
                rootEl.innerHTML = '<h1>Error: Contact database is not loaded correctly.</h1>';
                return;
            }

            const fullHash = window.location.hash || '';
            const relevantHash = fullHash.substring(fullHash.lastIndexOf('#') + 1);
            const isNew = relevantHash.includes('new=true');
            const isEdit = relevantHash.includes('edit=true');
            let contactId = null;

            if (relevantHash.includes('id=')) {
                contactId = relevantHash.split('id=')[1].split('&')[0];
            }

            if (isNew) {
                renderEditForm({});
            } else if (isEdit && contactId) {
                const contactToEdit = allContacts.find(c => c.id === contactId);
                renderEditForm(contactToEdit);
            } else if (contactId) {
                const contactToView = allContacts.find(c => c.id === contactId);
                renderView(contactToView);
            } else {
                rootEl.innerHTML = '<h1>Error: Invalid Contact URL</h1><a href="#list" class="btn">Back to List</a>';
            }

        } catch (error) {
            console.error('[Contact] A fatal error occurred during page logic:', error);
            rootEl.innerHTML = `<h1>A fatal script error occurred. Check the developer console.</h1>`;
        }

        function renderView(contact) {
            if (!contact) {
                rootEl.innerHTML = '<h1>Error: Contact Not Found</h1><a href="#list" class="btn">Back to List</a>'; return;
            }
            rootEl.innerHTML = `<h1>${contact.firstName || ''} ${contact.lastName || ''}</h1><div class="view-group"><div class="view-label">Notes</div><div class="view-data">${contact.notes || 'N/A'}</div></div><div class="btn-bar"><a href="#contact?edit=true&id=${contact.id}" class="btn">Edit</a><a href="#list" class="btn">Back to List</a></div>`;
        }

        function renderEditForm(contact) {
            if (!contact) {
                rootEl.innerHTML = '<h1>Error: Contact to edit was not found.</h1><a href="#list" class="btn">Back to List</a>'; return;
            }
            const isEditing = !!contact.id;
            rootEl.innerHTML = `<h1>${isEditing ? 'Edit Contact' : 'Add New Contact'}</h1><form id="contactForm"><div class="form-group"><label for="firstName">First Name</label><input type="text" id="firstName" name="firstName" value="${contact.firstName || ''}"></div><div class="form-group"><label for="lastName">Last Name</label><input type="text" id="lastName" name="lastName" value="${contact.lastName || ''}"></div><div class="form-group"><label for="notes">Notes</label><textarea id="notes" name="notes">${contact.notes || ''}</textarea></div><div class="btn-bar"><button type="submit" class="btn">Save Contact</button><a href="#list" class="btn">Cancel</a></div></form>`;
            document.getElementById('contactForm').addEventListener('submit', (e) => {
                e.preventDefault();
                handleSave(contact.id);
            });
        }

        function handleSave(existingId) {
            const currentContacts = App.getContacts();
            const form = document.getElementById('contactForm');
            const formData = new FormData(form);
            const savedData = Object.fromEntries(formData.entries());
            let updatedList;
            if (existingId) {
                savedData.id = existingId;
                updatedList = currentContacts.map(c => c.id === existingId ? savedData : c);
            } else {
                savedData.id = 'C' + Date.now();
                updatedList = [...currentContacts, savedData];
            }
            App.saveContacts(updatedList);
        }
    }); // End of the DOMContentLoaded listener
</script>