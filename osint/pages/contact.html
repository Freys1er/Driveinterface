<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Contact Details - ContactOSINT</title>
    <link rel="stylesheet" href="../style.css">
</head>
<body>

    <div id="app-container">
        <header>
            <nav>
                <a href="./dashboard.html">Dashboard</a>
                <a href="./list.html">Contacts</a>
                <a href="./network.html">Network</a>
            </nav>
            <button id="signout-button" class="btn">Sign Out</button>
        </header>

        <main id="page-content">
            <!-- The contact form or view will be rendered inside this container -->
            <div id="contact-container">
                <p>Loading contact details...</p>
            </div>
        </main>
    </div>

    <!-- External library scripts first -->
    <script src="../js/drive.js"></script>
    <script src="../js/app.js"></script>

    <!-- ===== START: NEW ROBUST SCRIPT BLOCK ===== -->
    <script>
        // --- EVENT LISTENERS ---
        document.getElementById('signout-button').addEventListener('click', () => {
            localStorage.removeItem(App.TOKEN_STORAGE_KEY);
            window.location.href = '/'; // Redirect to the main app's login
        });

        /**
         * This function contains the logic specific to THIS page (contact.html).
         */
        function runPageLogic() {
            const container = document.getElementById('contact-container');
            // This is a real page now, so we use `window.location.search` instead of `hash`
            const urlParams = new URLSearchParams(window.location.search);

            const contactId = urlParams.get('id');
            const isNew = urlParams.has('new');
            const isEdit = urlParams.has('edit');

            const allContacts = App.getContacts();
            let contactData = null;

            if (contactId) {
                contactData = allContacts.find(c => c.id === contactId);
            }

            // --- RENDER LOGIC ---
            if (isNew) {
                renderForm({}); // New contact form
            } else if (isEdit && contactData) {
                renderForm(contactData); // Edit existing contact form
            } else if (contactData) {
                renderView(contactData); // View contact details
            } else {
                container.innerHTML = `<h2>Contact Not Found</h2><a href="./list.html" class="btn">Back to List</a>`;
            }

            function renderView(contact) {
                let relationsHtml = '<p>No relationships defined.</p>';
                let relations = [];
                try {
                    // Ensure relations are parsed if they are a string
                    relations = typeof contact.relations === 'string' ? JSON.parse(contact.relations) : contact.relations || [];
                } catch (e) {
                    console.error("Could not parse relations:", e);
                }

                if (relations.length > 0) {
                    relationsHtml = relations.map(rel => {
                        const target = allContacts.find(c => c.id === rel.contactId);
                        const relationType = rel.type ? `(${rel.type})` : '';
                        const targetName = target ? `${target.firstName || ''} ${target.lastName || ''}`.trim() : 'Unknown';
                        return `<div class="relation-item"><span>→ ${targetName} ${relationType}</span></div>`;
                    }).join('');
                }

                container.innerHTML = `
                    <h2>${contact.firstName || ''} ${contact.lastName || ''}</h2>
                    <h4>Notes</h4>
                    <div class="contact-view-data">${contact.notes || 'N/A'}</div>
                    <div class="relations-section">
                        <h3>Relationships</h3>
                        ${relationsHtml}
                    </div>
                    <div class="btn-bar">
                        <a href="./contact.html?edit=true&id=${contact.id}" class="btn">Edit</a>
                        <a href="./list.html" class="btn" style="background-color:#555;">Back to List</a>
                    </div>
                `;
            }

            function renderForm(contact) {
                let currentRelations = [];
                 try {
                    currentRelations = typeof contact.relations === 'string' ? JSON.parse(contact.relations) : contact.relations || [];
                } catch (e) {}

                const otherContacts = allContacts.filter(c => c.id !== contact.id);
                const selectOptions = otherContacts.map(c => `<option value="${c.id}">${c.firstName} ${c.lastName}</option>`).join('');

                container.innerHTML = `
                    <h2>${contact.id ? 'Edit Contact' : 'Add New Contact'}</h2>
                    <form id="contactForm" class="contact-form">
                        <div class="form-group"><label for="firstName">First Name</label><input type="text" id="firstName" value="${contact.firstName || ''}"></div>
                        <div class="form-group"><label for="lastName">Last Name</label><input type="text" id="lastName" value="${contact.lastName || ''}"></div>
                        <div class="form-group"><label for="notes">Notes</label><textarea id="notes" rows="6">${contact.notes || ''}</textarea></div>
                        <div class="relations-section">
                            <h3>Relationships</h3>
                            <div id="relations-list"></div>
                            <h4>Add New Relationship</h4>
                            <div class="add-relation-form">
                                <select id="relation-contact-select" ${otherContacts.length === 0 ? 'disabled' : ''}>
                                    ${otherContacts.length > 0 ? selectOptions : '<option>No other contacts exist</option>'}
                                </select>
                                <input type="text" id="relation-type" placeholder="e.g., Friend, Colleague">
                                <button type="button" id="add-relation-btn" class="btn">Add</button>
                            </div>
                        </div>
                        <div class="btn-bar"><button type="submit" class="btn">Save</button><a href="./list.html" class="btn" style="background-color:#555;">Cancel</a></div>
                    </form>
                `;

                const relationsListEl = document.getElementById('relations-list');

                function displayRelations() {
                    if (currentRelations.length === 0) {
                        relationsListEl.innerHTML = '<p>No relationships defined.</p>';
                        return;
                    }
                    relationsListEl.innerHTML = currentRelations.map(rel => {
                        const target = allContacts.find(c => c.id === rel.contactId);
                        return `
                            <div class="relation-item">
                                <span>→ ${target ? (target.firstName + ' ' + target.lastName).trim() : 'Unknown'} (${rel.type})</span>
                                <button type="button" class="remove-relation-btn" data-id="${rel.contactId}">Remove</button>
                            </div>`;
                    }).join('');
                }

                document.getElementById('add-relation-btn').addEventListener('click', () => {
                    const selectEl = document.getElementById('relation-contact-select');
                    const typeEl = document.getElementById('relation-type');
                    if (!selectEl.value || !typeEl.value) { alert('Please select a contact and enter a relationship type.'); return; }
                    currentRelations.push({ contactId: selectEl.value, type: typeEl.value });
                    typeEl.value = '';
                    displayRelations();
                });

                relationsListEl.addEventListener('click', (e) => {
                    if (e.target.classList.contains('remove-relation-btn')) {
                        const targetId = e.target.getAttribute('data-id');
                        currentRelations = currentRelations.filter(r => r.contactId !== targetId);
                        displayRelations();
                    }
                });
                
                document.getElementById('contactForm').addEventListener('submit', (e) => {
                    e.preventDefault();
                    const savedData = {
                        id: contact.id || 'C' + Date.now(),
                        firstName: document.getElementById('firstName').value,
                        lastName: document.getElementById('lastName').value,
                        notes: document.getElementById('notes').value,
                        relations: currentRelations 
                    };

                    let updatedList;
                    if (contact.id) {
                        updatedList = allContacts.map(c => c.id === contact.id ? savedData : c);
                    } else {
                        updatedList = [...allContacts, savedData];
                    }
                    App.saveContacts(updatedList);
                });

                displayRelations();
            }
        }

        /**
         * Main bootstrap function.
         */
        async function initializeAndRun() {
            try {
                await gapi.client.init({
                    discoveryDocs: ['https://www.googleapis.com/discovery/v1/apis/drive/v3/rest'],
                });
                const isAuthenticated = await App.initializeAndAuth();
                if (isAuthenticated) {
                    await App.loadContacts(); // Load contacts before running page logic
                    runPageLogic();
                }
            } catch (error) {
                console.error("Initialization or Authentication Error:", error);
                document.getElementById('page-content').innerHTML = `<h1>Error</h1><p>Could not initialize the application.</p><a href="/">Return to Login</a>`;
            }
        }
        
        function loadScript(src) {
            return new Promise((resolve, reject) => {
                const script = document.createElement('script');
                script.src = src;
                script.async = true;
                script.defer = true;
                script.onload = resolve;
                script.onerror = reject;
                document.head.appendChild(script);
            });
        }

        // --- APPLICATION ENTRY POINT ---
        loadScript('https://apis.google.com/js/api.js')
            .then(() => {
                gapi.load('client', initializeAndRun);
            })
            .catch(error => {
                console.error('Failed to load Google API script:', error);
                document.body.innerHTML = '<h1>Critical Error</h1><p>Could not load Google libraries.</p>';
            });

    </script>
    <!-- ===== END: NEW ROBUST SCRIPT BLOCK ===== -->

</body>
</html>